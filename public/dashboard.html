<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - English Learning</title>
    <link rel="stylesheet" href="/styles.css"> <!-- Adjust path if CSS is elsewhere -->
</head>
<body>
    <header>
        <h1>Welcome to English Learning, <span id="username">User</span>!</h1>
        <button id="logoutButton">Log Out</button>
        <button id="donateButton">Donate</button>
    </header>
    <div class="container">
        <nav class="toc">
            <a href="#leaderboard" class="active">Leaderboard</a>
            <a href="#lessons">Lessons</a>
            <a href="#quizzes">Quizzes</a>
            <a href="#writing">Writing</a>
            <a href="#references">References</a>
            <a href="#blog">Blog</a>
        </nav>
        <div class="content">
            <p id="breadcrumb">Dashboard</p>
            <section id="leaderboard" class="active">
                <h2>Leaderboard</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Name</th>
                            <th>Homework</th>
                            <th>Comprehension</th>
                            <th>Pronunciation</th>
                            <th>Quizzes</th>
                            <th>Total Score</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </section>
            <section id="lessons">
                <h2>Lessons</h2>
                <select id="levelFilter">
                    <option value="">All Levels</option>
                    <option value="A1">A1</option>
                    <option value="A2">A2</option>
                    <option value="B1">B1</option>
                    <option value="B2">B2</option>
                    <option value="C1">C1</option>
                    <option value="C2">C2</option>
                </select>
                <select id="lessonJump">
                    <option value="">Jump to Lesson</option>
                </select>
                <div id="lessonList"></div>
            </section>
            <section id="quizzes">
                <h2>Quizzes</h2>
                <div id="quizList"></div>
            </section>
            <section id="writing">
                <h2>Writing Practice</h2>
                <textarea id="writingInput" rows="10" placeholder="Write here..."></textarea>
                <button id="submitWriting">Submit</button>
                <div id="writingFeedback"></div>
            </section>
            <section id="references">
                <h2>References</h2>
                <ul id="referenceList"></ul>
            </section>
            <section id="blog">
                <h2>Blog</h2>
                <div id="blogList"></div>
            </section>
        </div>
    </div>
    <button id="backToTop" style="display: none;">Back to Top</button>

    <!-- Stripe for donations -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Your updated script -->
    <script>
        const stripe = Stripe('pk_test_your_stripe_publishable_key');

        document.getElementById('logoutButton').addEventListener('click', () => {
            fetch('/api/logout', { method: 'GET' })
                .then(response => { if (response.redirected) window.location.href = response.url; })
                .catch(err => console.error('Logout error:', err));
        });

        document.getElementById('donateButton').addEventListener('click', () => {
            fetch('/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => {
                if (!res.ok) return res.json().then(errData => { throw new Error(errData.error || 'Unknown server error'); });
                return res.json();
            })
            .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
            .catch(err => {
                console.error('Donation error:', err.message);
                alert('Failed to initiate donation: ' + err.message);
            });
        });

        document.querySelectorAll('.toc a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    document.querySelectorAll('.content section').forEach(section => section.classList.remove('active'));
                    document.querySelectorAll('.toc a').forEach(a => a.classList.remove('active'));
                    targetSection.classList.add('active');
                    link.classList.add('active');
                    document.getElementById('breadcrumb').textContent = `Dashboard > ${link.textContent}`;
                }
            });
        });

        function updateLeaderboard(currentUser) {
            fetch('/api/leaderboard')
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to fetch leaderboard: ${res.status}`);
                    return res.json();
                })
                .then(users => {
                    const leaderboardBody = document.getElementById('leaderboardBody');
                    let html = '';
                    html += `
                        <tr class="current-user">
                            <td class="position">-</td>
                            <td class="name">${currentUser.name}</td>
                            <td>${(currentUser.homeworkScores || []).length}</td>
                            <td>${(currentUser.comprehensionScores || []).length}</td>
                            <td>${(currentUser.pronunciationScores || []).filter(s => s.correct).length}</td>
                            <td>${(currentUser.quizScores || []).length}</td>
                            <td class="total-score">${currentUser.score}%</td>
                        </tr>
                    `;
                    users.forEach((user, index) => {
                        if (user._id !== currentUser._id) {
                            html += `
                                <tr>
                                    <td class="position">${index + 1}</td>
                                    <td class="name">${user.name}</td>
                                    <td>${(user.homeworkScores || []).length}</td>
                                    <td>${(user.comprehensionScores || []).length}</td>
                                    <td>${(user.pronunciationScores || []).filter(s => s.correct).length}</td>
                                    <td>${(user.quizScores || []).length}</td>
                                    <td class="total-score">${user.score}%</td>
                                </tr>
                            `;
                        }
                    });
                    leaderboardBody.innerHTML = html || '<tr><td colspan="7">No users ranked yet</td></tr>';
                })
                .catch(err => console.error('Error loading leaderboard:', err));
        }

        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    if (res.status === 401) {
                        console.log('User not logged in, redirecting to auth');
                        window.location.href = '/auth.html';
                    }
                    throw new Error(`Failed to fetch user data: ${res.status}`);
                }
                return res.json();
            })
            .then(currentUser => {
                document.getElementById('username').textContent = currentUser.name || 'User';
                updateLeaderboard(currentUser);

                fetch('/api/lessons')
                    .then(res => res.json())
                    .then(lessons => {
                        const lessonList = document.getElementById('lessonList');
                        const lessonJump = document.getElementById('lessonJump');
                        const levelFilter = document.getElementById('levelFilter');

                        function renderLessons(filterLevel) {
                            lessonList.innerHTML = lessons
                                .filter(lesson => !filterLevel || lesson.level === filterLevel)
                                .map(lesson => `
                                    <details class="lesson" id="lesson-${lesson._id}">
                                        <summary>${lesson.title} (${lesson.level})</summary>
                                        <div class="lesson-content">
                                            <h3>Reading Section</h3>
                                            <p>${lesson.content}</p>
                                            ${lesson.comprehension?.questions?.length > 0 ? `
                                                <h4>Reading Comprehension</h4>
                                                <form class="comprehensionForm" data-lesson-id="${lesson._id}">
                                                    ${lesson.comprehension.questions.map((q, i) => `
                                                        <p>${q.question}</p>
                                                        <label><input type="radio" name="answer${i}" value="true" required> Yes/True</label>
                                                        <label><input type="radio" name="answer${i}" value="false"> No/False</label>
                                                    `).join('')}
                                                    <button type="submit">Submit Comprehension</button>
                                                </form>
                                            ` : ''}
                                            ${lesson.homework ? `
                                                <h4>Homework (${lesson.level})</h4>
                                                <form class="homeworkForm" data-lesson-id="${lesson._id}">
                                                    ${lesson.homework.map((q, i) => `
                                                        <p>${q.question}</p>
                                                        ${q.type === 'fill-in' ? `
                                                            <input type="text" name="answer${i}" required>
                                                        ` : `
                                                            <select name="answer${i}" required>
                                                                ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                                            </select>
                                                        `}
                                                    `).join('')}
                                                    <button type="submit">Submit Homework</button>
                                                </form>
                                            ` : ''}
                                            ${lesson.pronunciation ? `
                                                <h4>Pronunciation</h4>
                                                ${lesson.pronunciation.map((p, i) => `
                                                    <p>${p.phrase}</p>
                                                    <button class="recordButton" data-phrase="${p.phrase}" data-lesson-id="${lesson._id}" data-result-id="result-${lesson._id}-${i}">Record</button>
                                                    <span id="result-${lesson._id}-${i}"></span>
                                                `).join('')}
                                            ` : ''}
                                        </div>
                                    </details>
                                `).join('');
                            attachHandlers();
                        }

                        renderLessons('');
                        lessons.forEach(lesson => {
                            const option = document.createElement('option');
                            option.value = `lesson-${lesson._id}`;
                            option.textContent = `${lesson.title} (${lesson.level})`;
                            lessonJump.appendChild(option);
                        });
                        lessonJump.addEventListener('change', (e) => {
                            const targetId = e.target.value;
                            const target = document.getElementById(targetId);
                            if (target) {
                                document.querySelectorAll('.content section').forEach(s => s.classList.remove('active'));
                                document.querySelectorAll('.toc a').forEach(a => a.classList.remove('active'));
                                document.getElementById('lessons').classList.add('active');
                                document.querySelector('.toc a[href="#lessons"]').classList.add('active');
                                target.scrollIntoView({ behavior: 'smooth' });
                                target.open = true;
                            }
                            e.target.value = '';
                        });
                        levelFilter.addEventListener('change', (e) => renderLessons(e.target.value));

                        function attachHandlers() {
                            document.querySelectorAll('.homeworkForm').forEach(form => {
                                form.addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    const lessonId = form.dataset.lessonId;
                                    const answers = Array.from(form.querySelectorAll('input, select')).map(input => input.value);
                                    try {
                                        const res = await fetch('/api/homework', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ lessonId, answers })
                                        });
                                        if (!res.ok) throw new Error(await res.text());
                                        const result = await res.json();
                                        alert(`Score: ${Math.round((result.score / result.total) * 100)}%\n${result.feedback.map(f => `${f.question}: ${f.correct ? 'Correct' : `Wrong (${f.correctAnswer})`}`).join('\n')}`);
                                        updateLeaderboard(await (await fetch('/api/user-data')).json());
                                    } catch (err) {
                                        alert('Homework submission failed: ' + err.message);
                                        if (err.message.includes('401')) window.location.href = '/auth.html';
                                    }
                                });
                            });

                            document.querySelectorAll('.comprehensionForm').forEach(form => {
                                form.addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    const lessonId = form.dataset.lessonId;
                                    const answers = Array.from(form.querySelectorAll('input:checked')).map(input => input.value === 'true');
                                    try {
                                        const res = await fetch('/api/comprehension', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ lessonId, answers })
                                        });
                                        if (!res.ok) throw new Error(await res.text());
                                        const result = await res.json();
                                        alert(`Score: ${Math.round((result.score / result.total) * 100)}%\n${result.feedback.map(f => `${f.question}: ${f.correct ? 'Correct' : `Wrong (${f.correctAnswer ? 'Yes' : 'No'})`}`).join('\n')}`);
                                        updateLeaderboard(await (await fetch('/api/user-data')).json());
                                    } catch (err) {
                                        alert('Comprehension failed: ' + err.message);
                                        if (err.message.includes('401')) window.location.href = '/auth.html';
                                    }
                                });
                            });

                            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                            recognition.lang = 'en-US';
                            let isRecognizing = false;

                            document.querySelectorAll('.recordButton').forEach(button => {
                                button.addEventListener('click', () => {
                                    if (isRecognizing) return;
                                    const phrase = button.dataset.phrase;
                                    const lessonId = button.dataset.lessonId;
                                    const resultSpan = document.getElementById(button.dataset.resultId);
                                    recognition.start();
                                    isRecognizing = true;
                                    button.disabled = true;
                                    resultSpan.textContent = 'Listening...';

                                    recognition.onresult = async (event) => {
                                        const spokenText = event.results[0][0].transcript.toLowerCase().trim();
                                        const isCorrect = spokenText === phrase.toLowerCase().trim();
                                        resultSpan.textContent = isCorrect ? 'Correct!' : `Try again: "${spokenText}"`;
                                        isRecognizing = false;
                                        button.disabled = false;
                                        await fetch('/api/pronunciation', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ lessonId, phrase, isCorrect })
                                        });
                                        updateLeaderboard(await (await fetch('/api/user-data')).json());
                                    };

                                    recognition.onerror = (event) => {
                                        resultSpan.textContent = `Error: ${event.error}`;
                                        isRecognizing = false;
                                        button.disabled = false;
                                    };

                                    recognition.onend = () => {
                                        isRecognizing = false;
                                        button.disabled = false;
                                    };
                                });
                            });
                        }
                    });

                fetch('/api/quizzes')
                    .then(res => res.json())
                    .then(quizzes => {
                        document.getElementById('quizList').innerHTML = quizzes.map(quiz => `
                            <div class="quiz" data-id="${quiz._id}">
                                <h3>${quiz.title} (${quiz.level})</h3>
                                <p>Time: ${quiz.timeLimit}s</p>
                                <button class="startQuiz" data-id="${quiz._id}">Start</button>
                                <div class="quizContent" style="display: none;"></div>
                            </div>
                        `).join('');

                        document.querySelectorAll('.startQuiz').forEach(button => {
                            button.addEventListener('click', () => {
                                const quizId = button.dataset.id;
                                const quiz = quizzes.find(q => q._id === quizId);
                                const quizContent = button.nextElementSibling;
                                quizContent.style.display = 'block';
                                button.style.display = 'none';
                                let timeLeft = quiz.timeLimit;
                                quizContent.innerHTML = `
                                    <p>Time: <span id="timer-${quizId}">${timeLeft}</span>s</p>
                                    <form class="quizForm" data-id="${quizId}">
                                        ${quiz.questions.map((q, i) => `
                                            <p>${q.prompt}</p>
                                            <input type="text" name="answer${i}" required>
                                        `).join('')}
                                        <button type="submit">Submit</button>
                                    </form>
                                `;
                                const timer = setInterval(() => {
                                    timeLeft--;
                                    document.getElementById(`timer-${quizId}`).textContent = timeLeft;
                                    if (timeLeft <= 0) {
                                        clearInterval(timer);
                                        document.querySelector(`form[data-id="${quizId}"]`).dispatchEvent(new Event('submit'));
                                    }
                                }, 1000);

                                document.querySelector(`form[data-id="${quizId}"]`).addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    clearInterval(timer);
                                    const answers = Array.from(e.target.querySelectorAll('input')).map(input => input.value);
                                    try {
                                        const res = await fetch('/api/submit-quiz', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ quizId, answers })
                                        });
                                        if (!res.ok) throw new Error(await res.text());
                                        const result = await res.json();
                                        alert(`Score: ${Math.round((result.score / result.total) * 100)}%\n${result.feedback.map(f => `${f.prompt}: ${f.correct ? 'Correct' : `Wrong (${f.correctAnswer})`}`).join('\n')}`);
                                        updateLeaderboard(await (await fetch('/api/user-data')).json());
                                        quizContent.style.display = 'none';
                                        button.style.display = 'block';
                                    } catch (err) {
                                        alert('Quiz failed: ' + err.message);
                                        if (err.message.includes('401')) window.location.href = '/auth.html';
                                    }
                                });
                            });
                        });
                    });

                fetch('/api/references')
                    .then(res => res.json())
                    .then(references => {
                        document.getElementById('referenceList').innerHTML = references.length
                            ? references.map(ref => `<li><a href="${ref.url}" target="_blank">${ref.title}</a> - ${ref.description}</li>`).join('')
                            : '<li>No references available</li>';
                    });

                fetch('/api/blogs')
                    .then(res => res.json())
                    .then(blogs => {
                        document.getElementById('blogList').innerHTML = blogs.map(blog => `
                            <details class="blog-post">
                                <summary>${blog.title}</summary>
                                <p>${blog.content}</p>
                                <small>Posted: ${new Date(blog.createdAt).toLocaleDateString()}</small>
                            </details>
                        `).join('');
                    });

                document.getElementById('submitWriting').addEventListener('click', async () => {
                    const text = document.getElementById('writingInput').value.trim();
                    if (!text) return alert('Write something first!');
                    try {
                        const res = await fetch('/api/grade-writing', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text })
                        });
                        const result = await res.json();
                        document.getElementById('writingFeedback').innerHTML = `
                            <p><strong>Score:</strong> ${result.score}/100</p>
                            <p><strong>CEFR:</strong> ${result.cefr}</p>
                            <p><strong>Feedback:</strong> ${result.feedback}</p>
                        `;
                    } catch (err) {
                        alert('Writing grading failed: ' + err.message);
                    }
                });

                if (!localStorage.getItem('welcomeShown')) {
                    alert(`Welcome, ${currentUser.name || 'Learner'}! Check your progress!`);
                    localStorage.setItem('welcomeShown', 'true');
                }
            })
            .catch(err => {
                console.error('Dashboard fetch error:', err.message);
                if (err.message.includes('401')) window.location.href = '/auth.html';
            });

        const backToTop = document.getElementById('backToTop');
        document.querySelector('.content').addEventListener('scroll', () => {
            backToTop.style.display = document.querySelector('.content').scrollTop > 300 ? 'block' : 'none';
        });
        backToTop.addEventListener('click', () => {
            document.querySelector('.content').scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>