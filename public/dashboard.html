<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CHWMFJB2GE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CHWMFJB2GE');
    </script>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* Sidebar Styling Inspired by aoventures.io */
        .sidebar {
            width: 250px;
            padding: 20px 10px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            font-family: 'Inter', sans-serif;
        }
        .sidebar h1 {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 20px;
            padding-left: 10px;
        }
        .toc {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .toc li {
            margin: 0;
            padding: 8px 10px;
        }
        .toc a {
            text-decoration: none;
            color: #333;
            font-size: 16px;
            font-weight: 400;
            display: block;
            transition: color 0.3s;
        }
        .toc a:hover, .toc a.active {
            color: #3498db;
        }
        .toc button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            font-weight: 400;
            padding: 8px 10px;
            text-align: left;
            width: 100%;
            cursor: pointer;
            transition: color 0.3s;
        }
        .toc button:hover {
            color: #3498db;
        }
        #lessonJump {
            margin: 20px 10px 0;
            padding: 8px;
            width: calc(100% - 20px);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }
        /* Content Styling */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .breadcrumb {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        .content section {
    display: none;
}
.content section.active {
    display: block;
}
        /* Consistent h2 */
        h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 15px;
        }
        /* Back to Top */
        #backToTop {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            padding: 10px 20px;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #backToTop:hover {
            background: #2980b9;
        }
        /* Leaderboard Table Styling (Premier League Style) */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Inter', sans-serif;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .leaderboard-table th {
            background: #f5f5f5;
            font-weight: 700;
            color: #2c3e50;
            font-size: 14px;
        }
        .leaderboard-table td {
            font-size: 14px;
            color: #333;
        }
        .leaderboard-table tr:nth-child(even) {
            background: #fafafa;
        }
        .leaderboard-table tr:hover {
            background: #f0f0f0;
        }
        .leaderboard-table .position {
            width: 60px;
        }
        .leaderboard-table .name {
            text-align: left;
            width: 200px;
        }
        .leaderboard-table .total-score {
            font-weight: 700;
            color: #27ae60;
        }
        .leaderboard-table .current-user {
            background: #e6f3ff; /* Light blue highlight for current user */
            font-weight: 700;
        }

        /* Lesson Styling */
.lesson {
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    margin: 10px 0;
    padding: 15px;
    transition: background 0.3s;
}
.lesson:hover {
    background: #f5f5f5;
}
.lesson summary {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-weight: 400; /* Non-bold, elegant */
    font-size: 16px;
    color: #2c3e50;
    cursor: pointer;
    padding: 0;
    background: none;
    list-style: none;
    -webkit-font-smoothing: antialiased; /* Apple-like smoothness */
    -moz-osx-font-smoothing: grayscale;
}
.lesson summary::-webkit-details-marker {
    display: none;
}
.lesson summary::marker {
    display: none;
}
.lesson-content {
    padding: 15px 0 0;
    margin-top: 10px;
}
.lesson-content h3, .lesson-content h4 {
    color: #2980b9;
    margin: 10px 0;
}
.lesson-content form {
    margin: 10px 0;
}
.lesson-content button {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
}
.lesson-content button:hover {
    background: #2980b9;
}
    </style>
</head>
<body>
    <div class="container dashboard-container" style="display: flex;">
        <aside class="sidebar">
            <h1>Welcome, <span id="username"></span>!</h1>
            <ul class="toc">
                <li><a href="#leaderboard" class="active">Leaderboard</a></li>
                <li><a href="#lessons">Lessons</a></li>
                <li><a href="#quizzes">Quizzes</a></li>
                <li><a href="#reference">Reference</a></li>
                <li><a href="#blog">Blog</a></li>
                <li><button id="donateButton">Donate</button></li>
                <li><button id="logoutButton">Log Out</button></li>
            </ul>
            <select id="lessonJump">
                <option value="">Jump to Lesson</option>
            </select>
        </aside>
        <main class="content">
            <div class="breadcrumb" id="breadcrumb">Dashboard > Leaderboard</div>
            <section id="lessons">
                <h2>Lessons</h2>
                <select id="levelFilter">
                    <option value="">All Levels</option>
                    <option value="A1">A1</option>
                    <option value="A2">A2</option>
                    <option value="B1">B1</option>
                    <option value="B2">B2</option>
                    <option value="C1">C1</option>
                    <option value="C2">C2</option>
                </select>
                <div id="lessonList"></div>
            </section>
            <section id="quizzes">
                <h2>Quizzes</h2>
                <div id="quizList"></div>
            </section>
            <section id="reference">
                <h2>Reference Materials</h2>
                <p>Explore these resources to enhance your English skills:</p>
                <ul id="referenceList" class="reference-list"></ul>
            </section>
            <section id="blog">
                <h2>Blog</h2>
                <div id="blogList"></div>
            </section>
            <section id="leaderboard" class="active">
                <h2>Leaderboard</h2>
                <table class="leaderboard-table" id="leaderboardTable">
                    <thead>
                        <tr>
                            <th class="position">Pos</th>
                            <th class="name">Name</th>
                            <th>HW</th>
                            <th>Comp</th>
                            <th>Pron</th>
                            <th>Quiz</th>
                            <th class="total-score">Score</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </section>
        </main>
        <button id="backToTop">Back to Top</button>
    </div>
    <script src="/script.js"></script>
    <script>
        const stripe = Stripe('pk_test_your_stripe_publishable_key');
    
        document.getElementById('logoutButton').addEventListener('click', () => {
            fetch('/api/logout', { method: 'GET' })
                .then(response => { if (response.redirected) window.location.href = response.url; })
                .catch(err => console.error('Logout error:', err));
        });
    
        document.getElementById('donateButton').addEventListener('click', () => {
            fetch('/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => {
                if (!res.ok) return res.json().then(errData => { throw new Error(errData.error || 'Unknown server error'); });
                return res.json();
            })
            .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
            .catch(err => {
                console.error('Donation error:', err.message);
                alert('Failed to initiate donation: ' + err.message);
            });
        });
    
        document.querySelectorAll('.toc a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    document.querySelectorAll('.content section').forEach(section => section.classList.remove('active'));
                    document.querySelectorAll('.toc a').forEach(a => a.classList.remove('active'));
                    targetSection.classList.add('active');
                    link.classList.add('active');
                    document.getElementById('breadcrumb').textContent = `Dashboard > ${link.textContent}`;
                }
            });
        });
    
        // Function to update leaderboard without switching views
        function updateLeaderboard(currentUser) {
            fetch('/api/leaderboard')
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to fetch leaderboard: ${res.status}`);
                    return res.json();
                })
                .then(users => {
                    console.log('Leaderboard received:', users);
                    const leaderboardBody = document.getElementById('leaderboardBody');
                    let html = '';
    
                    // Current user at the top
                    html += `
                        <tr class="current-user">
                            <td class="position">-</td>
                            <td class="name">${currentUser.name}</td>
                            <td>${(currentUser.homeworkScores || []).length}</td>
                            <td>${(currentUser.comprehensionScores || []).length}</td>
                            <td>${(currentUser.pronunciationScores || []).filter(s => s.correct).length}</td>
                            <td>${(currentUser.quizScores || []).length}</td>
                            <td class="total-score">${currentUser.score}%</td>
                        </tr>
                    `;
    
                    // Ranked users, skipping current user
                    users.forEach((user, index) => {
                        if (user._id !== currentUser._id) {
                            html += `
                                <tr>
                                    <td class="position">${index + 1}</td>
                                    <td class="name">${user.name}</td>
                                    <td>${(user.homeworkScores || []).length}</td>
                                    <td>${(user.comprehensionScores || []).length}</td>
                                    <td>${(user.pronunciationScores || []).filter(s => s.correct).length}</td>
                                    <td>${(user.quizScores || []).length}</td>
                                    <td class="total-score">${user.score}%</td>
                                </tr>
                            `;
                        }
                    });
    
                    leaderboardBody.innerHTML = html || '<tr><td colspan="7">No users ranked yet</td></tr>';
                })
                .catch(err => console.error('Error loading leaderboard:', err));
        }
    
        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    if (res.status === 401) {
                        console.log('User not logged in, redirecting to login');
                        window.location.href = '/index.html';
                    }
                    throw new Error(`Failed to fetch user data: ${res.status}`);
                }
                return res.json();
            })
            .then(currentUser => {
                console.log('Current user data:', currentUser);
                document.getElementById('username').textContent = currentUser.name || 'User';
    
                // Initial Leaderboard Load
                updateLeaderboard(currentUser);
    
                // Load Lessons and Jump to Lesson
                let allLessons = [];
                fetch('/api/lessons')
                    .then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch lessons: ${res.status}`);
                        return res.json();
                    })
                    .then(lessons => {
                        console.log('Lessons received:', lessons);
                        allLessons = lessons;
                        const lessonList = document.getElementById('lessonList');
                        const lessonJump = document.getElementById('lessonJump');
                        const levelFilter = document.getElementById('levelFilter');
    
                        function renderLessons(filterLevel) {
                            lessonList.innerHTML = `
                                ${allLessons.filter(lesson => !filterLevel || lesson.level === filterLevel).map(lesson => `
                                    <details class="lesson" id="lesson-${lesson._id}">
                                        <summary>${lesson.title} (${lesson.level})</summary>
                                        <div class="lesson-content">
                                            <h3>Reading Section</h3>
                                            <p>${lesson.content}</p>
                                            ${lesson.comprehension && lesson.comprehension.questions && lesson.comprehension.questions.length > 0 ? `
                                                <h4>Reading Comprehension</h4>
                                                <form class="comprehensionForm" data-lesson-id="${lesson._id}">
                                                    <div class="questions">
                                                        ${lesson.comprehension.questions.map((q, i) => `
                                                            <p>${q.question}</p>
                                                            <label><input type="radio" name="answer${i}" value="true" required> Yes/True</label>
                                                            <label><input type="radio" name="answer${i}" value="false"> No/False</label>
                                                        `).join('')}
                                                    </div>
                                                    <button type="submit">Submit Comprehension</button>
                                                </form>
                                            ` : ''}
                                            ${lesson.homework ? `
                                                <h4>Homework (${lesson.level})</h4>
                                                <form class="homeworkForm" data-lesson-id="${lesson._id}">
                                                    ${lesson.homework.map((q, i) => `
                                                        <p>${q.question}</p>
                                                        ${q.type === 'fill-in' ? `
                                                            <input type="text" name="answer${i}" placeholder="Your answer" required>
                                                        ` : `
                                                            <select name="answer${i}" required>
                                                                ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                                            </select>
                                                        `}
                                                    `).join('')}
                                                    <button type="submit">Submit Homework</button>
                                                </form>
                                            ` : ''}
                                            ${lesson.pronunciation ? `
                                                <h4>Practice Pronunciation</h4>
                                                ${lesson.pronunciation.map((p, i) => `
                                                    <p>${p.phrase}</p>
                                                    <button class="recordButton" data-phrase="${p.phrase}" data-lesson-id="${lesson._id}" data-result-id="result-${lesson._id}-${i}">Record</button>
                                                    <span id="result-${lesson._id}-${i}"></span>
                                                `).join('')}
                                            ` : ''}
                                        </div>
                                    </details>
                                `).join('')}
                            `;
                            // Attach handlers after rendering
                            attachHomeworkHandler();
                            attachComprehensionHandler();
                            attachRecordHandler();
                        }
    
                        renderLessons('');
                        lessons.forEach(lesson => {
                            const option = document.createElement('option');
                            option.value = `lesson-${lesson._id}`;
                            option.textContent = `${lesson.title} (${lesson.level})`;
                            lessonJump.appendChild(option);
                        });
                        lessonJump.addEventListener('change', (e) => {
                            const targetId = e.target.value;
                            const target = document.getElementById(targetId);
                            if (target) {
                                document.querySelectorAll('.content section').forEach(section => section.classList.remove('active'));
                                document.querySelectorAll('.toc a').forEach(a => a.classList.remove('active'));
                                document.getElementById('lessons').classList.add('active');
                                document.querySelector('.toc a[href="#lessons"]').classList.add('active');
                                document.getElementById('breadcrumb').textContent = `Dashboard > Lessons > ${target.querySelector('summary').textContent}`;
                                target.scrollIntoView({ behavior: 'smooth' });
                                target.open = true;
                            }
                            e.target.value = '';
                        });
                        levelFilter.addEventListener('change', (e) => renderLessons(e.target.value));
    
                        // Homework Submission Handler
                        function attachHomeworkHandler() {
                            document.querySelectorAll('.homeworkForm').forEach(form => {
                                form.addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    const lessonId = form.dataset.lessonId;
                                    const answers = Array.from(form.querySelectorAll('input, select')).map(input => input.value);
                                    console.log('Submitting homework:', { lessonId, answers });
                                    try {
                                        const response = await fetch('/api/homework', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ lessonId, answers })
                                        });
                                        if (!response.ok) {
                                            const errorText = await response.text();
                                            throw new Error(`Homework submission failed: ${response.status} - ${errorText}`);
                                        }
                                        const result = await response.json();
                                        console.log('Homework result:', result);
                                        const percentage = Math.round((result.score / result.total) * 100);
                                        let feedback = `Score: ${percentage}% (${result.score}/${result.total} correct)\n`;
                                        result.feedback.forEach(f => {
                                            feedback += `${f.question}: ${f.correct ? 'Correct!' : `Wrong, try: ${f.correctAnswer}`}\n`;
                                        });
                                        alert(feedback);
                                        document.getElementById('lessons').classList.add('active');
                                        document.querySelector('.toc a[href="#lessons"]').classList.add('active');
                                        document.getElementById('breadcrumb').textContent = `Dashboard > Lessons`;
                                        fetch('/api/user-data').then(res => res.json()).then(updateData => {
                                            updateLeaderboard(updateData);
                                        });
                                    } catch (err) {
                                        console.error('Homework fetch error:', err.message);
                                        alert('Failed to submit homework: ' + err.message);
                                        if (err.message.includes('401')) window.location.href = '/index.html';
                                    }
                                });
                            });
                        }
    
                        // Comprehension Submission Handler
                        function attachComprehensionHandler() {
                            document.querySelectorAll('.comprehensionForm').forEach(form => {
                                form.addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    const lessonId = form.dataset.lessonId;
                                    const answers = Array.from(form.querySelectorAll('input:checked')).map(input => input.value === 'true');
                                    console.log('Submitting comprehension:', { lessonId, answers });
                                    try {
                                        const response = await fetch('/api/comprehension', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ lessonId, answers })
                                        });
                                        if (!response.ok) {
                                            const errorText = await response.text();
                                            throw new Error(`Comprehension submission failed: ${response.status} - ${errorText}`);
                                        }
                                        const result = await response.json();
                                        console.log('Comprehension result:', result);
                                        const percentage = Math.round((result.score / result.total) * 100);
                                        let feedback = `Score: ${percentage}% (${result.score}/${result.total} correct)\n`;
                                        result.feedback.forEach(f => {
                                            feedback += `${f.question}: ${f.correct ? 'Correct!' : `Wrong, answer: ${f.correctAnswer ? 'Yes/True' : 'No/False'}`}\n`;
                                        });
                                        alert(feedback);
                                        document.getElementById('lessons').classList.add('active');
                                        document.querySelector('.toc a[href="#lessons"]').classList.add('active');
                                        document.getElementById('breadcrumb').textContent = `Dashboard > Lessons`;
                                        fetch('/api/user-data').then(res => res.json()).then(updateData => {
                                            updateLeaderboard(updateData);
                                        });
                                    } catch (err) {
                                        console.error('Comprehension fetch error:', err.message);
                                        alert('Failed to submit comprehension: ' + err.message);
                                        if (err.message.includes('401')) window.location.href = '/index.html';
                                    }
                                });
                            });
                        }
    
                        // Pronunciation Handler
                        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                        recognition.lang = 'en-US';
                        recognition.interimResults = false;
                        recognition.maxAlternatives = 1;
                        let isRecognizing = false;
    
                        function normalizeText(text) {
                            return text.toLowerCase().trim().replace(/’/g, "'");
                        }
    
                        function levenshteinDistance(a, b) {
                            const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
                            for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
                            for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
                            for (let j = 1; j <= b.length; j++) {
                                for (let i = 1; i <= a.length; i++) {
                                    const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
                                    matrix[j][i] = Math.min(
                                        matrix[j][i - 1] + 1,
                                        matrix[j - 1][i] + 1,
                                        matrix[j - 1][i - 1] + indicator
                                    );
                                }
                            }
                            return matrix[b.length][a.length];
                        }
    
                        function attachRecordHandler() {
                            document.querySelectorAll('.recordButton').forEach(button => {
                                button.addEventListener('click', () => {
                                    if (isRecognizing) {
                                        console.log('Already recognizing, please wait...');
                                        return;
                                    }
                                    const phrase = button.dataset.phrase;
                                    const lessonId = button.dataset.lessonId;
                                    const resultId = button.dataset.resultId;
                                    const resultSpan = document.getElementById(resultId);
    
                                    console.log('Starting recognition for:', phrase);
                                    recognition.start();
                                    isRecognizing = true;
                                    button.disabled = true;
                                    resultSpan.textContent = 'Listening...';
    
                                    recognition.onresult = (event) => {
                                        const spokenText = normalizeText(event.results[0][0].transcript);
                                        const expectedText = normalizeText(phrase);
                                        console.log('Heard:', spokenText, 'Expected:', expectedText);
                                        const isCorrect = spokenText === expectedText || levenshteinDistance(spokenText, expectedText) <= 2;
                                        resultSpan.textContent = isCorrect ? 'Correct!' : `Try again: heard "${spokenText}"`;
                                        isRecognizing = false;
                                        button.disabled = false;
    
                                        fetch('/api/pronunciation', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ lessonId, phrase, isCorrect })
                                        })
                                        .then(res => {
                                            if (!res.ok) {
                                                return res.text().then(text => { throw new Error(`Pronunciation save failed: ${res.status} - ${text}`); });
                                            }
                                            return res.text();
                                        })
                                        .then(text => {
                                            console.log('Pronunciation saved:', text);
                                            fetch('/api/user-data').then(res => res.json()).then(updateData => {
                                                updateLeaderboard(updateData);
                                            });
                                        })
                                        .catch(err => {
                                            console.error('Pronunciation save error:', err.message);
                                            alert('Failed to save pronunciation: ' + err.message);
                                            if (err.message.includes('401')) window.location.href = '/index.html';
                                        });
                                    };
    
                                    recognition.onerror = (event) => {
                                        console.error('Recognition error:', event.error);
                                        resultSpan.textContent = `Error: ${event.error}${event.error === 'network' ? ' - Check internet' : ''}`;
                                        isRecognizing = false;
                                        button.disabled = false;
                                    };
    
                                    recognition.onend = () => {
                                        console.log('Recognition ended');
                                        if (!resultSpan.textContent || resultSpan.textContent === 'Listening...') {
                                            resultSpan.textContent = 'No speech detected';
                                        }
                                        isRecognizing = false;
                                        button.disabled = false;
                                    };
                                });
                            });
                        }
                    })
                    .catch(err => console.error('Error loading lessons:', err));
    
                // Load Quizzes
                fetch('/api/quizzes')
                    .then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch quizzes: ${res.status}`);
                        return res.json();
                    })
                    .then(quizzes => {
                        console.log('Quizzes received:', quizzes);
                        document.getElementById('quizList').innerHTML = `
                            ${quizzes.map(quiz => `
                                <div class="quiz" data-id="${quiz._id}">
                                    <h3>${quiz.title} (${quiz.level})</h3>
                                    <p>Time Limit: ${quiz.timeLimit} seconds</p>
                                    <button class="startQuiz" data-id="${quiz._id}">Start Quiz</button>
                                    <div class="quizContent" style="display: none;"></div>
                                </div>
                            `).join('')}
                        `;
    
                        document.querySelectorAll('.startQuiz').forEach(button => {
                            button.addEventListener('click', () => {
                                const quizId = button.dataset.id;
                                const quiz = quizzes.find(q => q._id === quizId);
                                const quizContent = button.nextElementSibling;
                                quizContent.style.display = 'block';
                                button.style.display = 'none';
                                let timeLeft = quiz.timeLimit;
                                quizContent.innerHTML = `
                                    <p>Time Remaining: <span id="timer-${quizId}">${timeLeft}</span> seconds</p>
                                    <form class="quizForm" data-id="${quizId}">
                                        ${quiz.type === 'matching' ? `
                                            ${quiz.questions.map((q, i) => `
                                                <p>${q.prompt}</p>
                                                <select name="answer${i}" required>
                                                    ${quiz.questions.map(opt => `<option value="${opt.correctAnswer}">${opt.correctAnswer}</option>`).join('')}
                                                </select>
                                            `).join('')}
                                        ` : `
                                            ${quiz.questions.map((q, i) => `
                                                <p>${q.prompt}</p>
                                                <input type="text" name="answer${i}" required>
                                            `).join('')}
                                        `}
                                        <button type="submit">Submit Quiz</button>
                                    </form>
                                `;
                                const timer = setInterval(() => {
                                    timeLeft--;
                                    document.getElementById(`timer-${quizId}`).textContent = timeLeft;
                                    if (timeLeft <= 0) {
                                        clearInterval(timer);
                                        document.querySelector(`form[data-id="${quizId}"]`).dispatchEvent(new Event('submit'));
                                    }
                                }, 1000);
    
                                document.querySelector(`form[data-id="${quizId}"]`).addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    clearInterval(timer);
                                    const answers = Array.from(e.target.querySelectorAll('select, input')).map(input => input.value);
                                    try {
                                        const response = await fetch('/api/submit-quiz', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ quizId, answers })
                                        });
                                        if (!response.ok) {
                                            const errorText = await response.text();
                                            throw new Error(`Quiz submission failed: ${response.status} - ${errorText}`);
                                        }
                                        const result = await response.json();
                                        console.log('Quiz result:', result);
                                        const percentage = Math.round((result.score / result.total) * 100);
                                        let feedback = `Score: ${percentage}% (${result.score}/${result.total} correct)\n`;
                                        result.feedback.forEach(f => {
                                            feedback += `${f.prompt}: ${f.correct ? 'Correct!' : `Wrong, answer: ${f.correctAnswer}`}\n`;
                                        });
                                        alert(feedback);
                                        fetch('/api/user-data').then(res => res.json()).then(updateData => {
                                            updateLeaderboard(updateData);
                                        });
                                        quizContent.style.display = 'none';
                                        button.style.display = 'block';
                                    } catch (err) {
                                        console.error('Quiz fetch error:', err.message);
                                        alert('Failed to submit quiz: ' + err.message);
                                        if (err.message.includes('401')) window.location.href = '/index.html';
                                    }
                                });
                            });
                        });
                    })
                    .catch(err => console.error('Error loading quizzes:', err));
    
                // Load References
                fetch('/api/references')
                    .then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch references: ${res.status}`);
                        return res.json();
                    })
                    .then(references => {
                        console.log('References received:', references);
                        document.getElementById('referenceList').innerHTML = references.length > 0 
                            ? references.map(ref => `
                                <li>
                                    <input type="checkbox" class="refCheckbox" data-id="${ref._id}" ${currentUser.referencesVisited && currentUser.referencesVisited.includes(ref._id) ? 'checked' : ''}>
                                    <a href="${ref.url}" target="_blank">${ref.title}</a> - ${ref.description}
                                </li>
                            `).join('')
                            : '<li>No references available</li>';
                    })
                    .catch(err => console.error('Error loading references:', err));
    
                // Load Blog
                fetch('/api/blogs')
                    .then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch blogs: ${res.status}`);
                        return res.json();
                    })
                    .then(blogs => {
                        console.log('Blogs received:', blogs);
                        document.getElementById('blogList').innerHTML = `
                            ${blogs.map(blog => `
                                <details class="blog-post">
                                    <summary>${blog.title}</summary>
                                    <p>${blog.content}</p>
                                    <small>Posted on: ${new Date(blog.createdAt).toLocaleDateString()}</small>
                                </details>
                            `).join('')}
                        `;
                    })
                    .catch(err => console.error('Error loading blogs:', err));
    
                if (!localStorage.getItem('welcomeShown')) {
                    alert(`Welcome, ${currentUser.name || 'Learner'}! Check your progress on the leaderboard!`);
                    localStorage.setItem('welcomeShown', 'true');
                }
            })
            .catch(err => {
                console.error('Dashboard fetch error:', err.message);
                if (err.message.includes('401')) window.location.href = '/index.html';
            });
    
        const backToTop = document.getElementById('backToTop');
        document.querySelector('.content').addEventListener('scroll', () => {
            backToTop.style.display = document.querySelector('.content').scrollTop > 300 ? 'block' : 'none';
        });
        backToTop.addEventListener('click', () => {
            document.querySelector('.content').scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>